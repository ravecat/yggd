name: release
run-name: ${{ github.event_name == 'workflow_dispatch' && format('release {0}', github.event.inputs.release) || github.event.head_commit.message }}

on:
  push:
    branches:
      - master
    tags:
      - v*.*.*
      - "*.*.*"
  workflow_dispatch:
    inputs:
      release:
        description: "Release"
        required: true
        type: choice
        options:
          - packages
          - apps

permissions:
  contents: read

jobs:
  metadata:
    name: Collect data about app
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.apps.outputs.apps }}
      packages: ${{ steps.packages.outputs.packages }}
      affected_apps: ${{ steps.affected.outputs.apps }}
      affected_packages: ${{ steps.affected.outputs.packages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: Prepare Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set SHAs for affected detection
        uses: nrwl/nx-set-shas@v4

      - name: Detect affected projects
        id: affected
        run: |
          PACKAGES=$(npx nx show projects --type lib --affected | paste -sd ',')
          APPS=$(npx nx show projects --type app --affected | paste -sd ',')
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          echo "Found affected packages: $PACKAGES"
          echo "Found affected apps: $APPS"

      - name: Collect monorepo apps
        id: apps
        run: |
          APPS=$(npx nx show projects --type app --json | jq -c 'map({app: .}) | {include: .}')
          echo "apps=$APPS" >> $GITHUB_OUTPUT
          echo "Current apps: $APPS"

      - name: Collect monorepo packages
        id: packages
        run: |
          PACKAGES=$(npx nx show projects --type lib --json | jq -c 'map({package: .}) | {include: .}')
          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT
          echo "Current packages: $PACKAGES"

  release:
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: write
      packages: write
      actions: read
      pull-requests: read
    name: Release apps and packages
    runs-on: ubuntu-latest
    needs: [metadata]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0
          persist-credentials: true

      - name: Set Git user
        run: |
          git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config user.name "${{ github.actor }}"

      - name: Prepare Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Release packages (preview)
        if: >
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: |
          npx nx run-many -t build -p ${{ needs.metadata.outputs.affected_packages }} --parallel
          npx nx release --projects=${{ needs.metadata.outputs.affected_packages }} --dry-run --verbose

      - name: Release apps (preview)
        if: >
          github.event_name == 'push' &&
          github.ref == 'refs/heads/master'
        run: npx nx release --projects=${{ needs.metadata.outputs.affected_apps }} --dry-run --verbose

      - name: Release packages
        if: >
          github.event_name == 'workflow_dispatch' &&
          github.ref == 'refs/heads/master' &&
          github.event.inputs.release == 'packages'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx nx run-many -t build -p ${{ needs.metadata.outputs.affected_packages }} --parallel
          npx nx release --projects=${{ needs.metadata.outputs.affected_packages }}

      - name: Release apps
        if: >
          github.event_name == 'workflow_dispatch' &&
          github.ref == 'refs/heads/master' &&
          github.event.inputs.release == 'apps'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx nx release --projects=${{ needs.metadata.outputs.affected_apps }} --skip-publish

  docker:
    name: Build and Push Docker Image to GHCR
    runs-on: ubuntu-latest
    needs: [release, metadata]
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'apps') ||
      (github.event_name == 'push' && needs.metadata.outputs.affected_apps != '')
    env:
      REGISTRY: ghcr.io
    permissions:
      contents: read
      packages: write
    strategy:
      matrix: ${{ fromJson(needs.metadata.outputs.apps) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.app }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix=,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/${{ matrix.app }}
          file: ./apps/${{ matrix.app }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.app }}
          cache-to: type=gha,mode=max,scope=${{ matrix.app }}
          platforms: linux/amd64,linux/arm64
